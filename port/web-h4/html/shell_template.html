<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>BTstack Example: ${EXAMPLE}</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css"
        />
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                display: flex;
                flex-direction: column;
            }
            body {
                font-family: system-ui, sans-serif;
                background-color: #f9fafb;
                color: #333;
                min-height: 100vh;
            }

            header {
                background-color: #fff;
                border-bottom: 1px solid #ddd;
                padding: 0.6rem 1rem;
            }

            header h1 {
                margin: 0;
                font-size: 1.1rem;
                font-weight: 600;
            }

            #configSummary {
                background-color: #f1f3f5;
                padding: 0.5rem 1rem;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                font-size: 0.9rem;
                gap: 0.6rem;
            }

            #leftConfig {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 0.6rem;
            }

            label {
                font-weight: 500;
            }

            input,
            select {
                border-radius: 6px;
                border: 1px solid #ccc;
                font-size: 0.9rem;
                padding: 0.3rem 0.6rem;
            }

            input.hidden,
            select.hidden,
            label.hidden {
                display: none;
            }

            #debugToggle {
                display: flex;
                align-items: center;
                gap: 0.3rem;
            }

            #terminal-container {
                flex: 1;
                display: flex;
                background: black;
                overflow: hidden;
            }

            #terminal {
                height: 100%;
                width: 100%;
            }

            button {
                border-radius: 6px;
                border: none;
                font-size: 0.9rem;
                padding: 0.3rem 0.6rem;
                background-color: #007bff;
                color: white;
                cursor: pointer;
                transition: background 0.2s ease;
            }

            button:hover:enabled {
                background-color: #0056b3;
            }

            button:disabled {
                background-color: #ccc;
                cursor: not-allowed;
            }
        </style>
        <script src="buffered_reader.js"></script>
    </head>

    <body>
        <header>
            <h1 id="appTitle">BTstack Example: ${EXAMPLE}</h1>
        </header>

        <div id="configSummary">
            <div id="leftConfig">
                <label for="moduleSelect">Module:</label>
                <select id="moduleSelect"></select>

                <label for="baudrate">Baud:</label>
                <select id="baudrate">
                    <option selected>115200</option>
                    <option selected>230400</option>
                    <option selected>921600</option>
                    <option selected>1000000</option>
                    <option selected>3000000</option>
                </select>

                <label for="patchUrl" id="patchLabel">Patch:</label>
                <input
                    type="text"
                    id="patchUrl"
                    placeholder="https://example.com/patchram.hcd"
                    style="min-width: 220px"
                />
            </div>

            <div style="display: flex; align-items: center; gap: 0.5rem">
                <label id="debugToggle">
                    <input type="checkbox" id="debugLog" />
                    Debug Log
                </label>
                <label id="hciToggle">
                    <input type="checkbox" id="hciLog" />
                    HCI Log
                </label>
                <!--<button id="downloadLogBtn">Download HCI Packet Log</button>-->
                <button id="connectBtn">Connect</button>
            </div>
        </div>

        <div id="terminal-container">
            <div id="terminal"></div>
        </div>

        <!-- handle terminal-->
        <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.min.js"></script>
        <script>
            // forward STDIN char by char
            function handleStdin(data) {
                term.writeln(data);
                for (let i = 0; i < data.length; i++) {
                    _btstack_stdin_js_process( data.charCodeAt(i) );
                }
            }

            const term = new window.Terminal({
                cursorBlink: true,
                theme: { background: "#000000", foreground: "#ffffff" },
            });
            term.open(document.getElementById("terminal"));
            term.onData((data) => handleStdin(data));

            // Load and apply FitAddon
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            fitAddon.fit();

            // Re-fit on window resize
            window.addEventListener("resize", () => fitAddon.fit());

            const moduleSelect = document.getElementById("moduleSelect");
            const baudrateSelect = document.getElementById("baudrate");
            const patchUrlInput = document.getElementById("patchUrl");
            const patchLabel = document.getElementById("patchLabel");
            const debugToggle = document.getElementById("debugLog");
            const hciToggle = document.getElementById("hciLog");
            const connectBtn = document.getElementById("connectBtn");
            const downloadBtn = document.getElementById("downloadLogBtn");

            let config = {
                module: "",
                baud: 115200,
                patchUrl: "",
                debug: false,
            };

            const moduleList = [
                {
                    key: "Generic_115200",
                    label: "Generic HCI H4 Controller at 115200",
                },
                {
                    key: "Generic_921600",
                    label: "Generic HCI H4 Controller at 921600",
                },
                {
                    key: "Generic_1000000",
                    label: "Generic HCI H4 Controller at 1000000",
                },
                {
                    key: "Generic_1000000",
                    label: "nRF5x with HCI UART Bridge at 1000000",
                },
            ];

            const moduleDefaults = {
                Generic_115200: { baud: 115200 },
                Generic_921600: { baud: 921600 },
                Generic_1000000: { baud: 1000000 },
            };

            function populateModuleSelect() {
                moduleSelect.innerHTML = "";

                // Populate in manual order using label for display
                moduleList.forEach((mod) => {
                    const opt = document.createElement("option");
                    opt.value = mod.key;
                    opt.textContent = mod.label;
                    moduleSelect.appendChild(opt);
                });

                // Add Custom option at the end
                const customOpt = document.createElement("option");
                customOpt.value = "Custom";
                customOpt.textContent = "Custom (Manual Config)";
                moduleSelect.appendChild(customOpt);

                // Default to first defined module
                moduleSelect.value = moduleList[0].key;
            }

            function updateConfigFromUI() {
                config.module = moduleSelect.value;
                const isCustom = config.module === "Custom";
                const isAiroc = config.module === "AIROC";
                console.log("Module selected " +  config.module);

                // Patch field visible only for AIROC
                const showPatch = isAiroc;
                patchUrlInput.classList.toggle("hidden", !showPatch);
                patchLabel.classList.toggle("hidden", !showPatch);

                // Baud editable only for Custom
                baudrateSelect.disabled = !isCustom;

                if (isCustom) {
                    config.baud = parseInt(baudrateSelect.value, 10);
                    config.patchUrl = patchUrlInput.value.trim();
                } else {
                    const defaults = moduleDefaults[config.module] || {};
                    config.baud = defaults.baud || 115200;
                    config.patchUrl = defaults.patchUrl || "";
                    baudrateSelect.value = config.baud;
                    patchUrlInput.value = config.patchUrl;
                }

                // get logging options
                config.debug = debugToggle.checked;
                config.hci = hciToggle.checked;
                console.log("HCI Toggle checked " + hciToggle.checked);
            }

            function updateBTstackLoggingFromConfig() {
                _main_set_log_level(config.debug ? 1 : 2);
                _main_set_hci_log(config.hci);
            }

            // Event listeners
            moduleSelect.addEventListener("change", () => {
                updateConfigFromUI();
                term.writeln("Module selected: " + config.module);
            });

            baudrateSelect.addEventListener("change", () => {
                if (config.module === "Custom")
                    config.baud = parseInt(baudrateSelect.value, 10);
            });

            patchUrlInput.addEventListener("input", () => {
                if (config.module === "AIROC" || config.module === "Custom")
                    config.patchUrl = patchUrlInput.value.trim();
            });

            debugToggle.addEventListener("change", () => {
                updateConfigFromUI();
                updateBTstackLoggingFromConfig();
            });

            hciToggle.addEventListener("change", () => {
                updateConfigFromUI();
                updateBTstackLoggingFromConfig();
            });

            populateModuleSelect();
            updateConfigFromUI();

            // Connect logic
            connectBtn.addEventListener("click", async () => {
                updateConfigFromUI();
                if (!("serial" in navigator)) {
                    term.writeln(
                        "\x1b[31mError:\x1b[0m Web Serial API not supported.",
                    );
                    return;
                }
                _main_set_initial_baudrate(config.baud);
                Module.onStartBTstack();
            });

            // download HCI log
            if (downloadBtn) {
                let logBuffer = "";
                downloadBtn.addEventListener("click", () => {
                    const blob = new Blob([logBuffer], { type: "text/plain" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "hci_log.txt";
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }

            // Check WebSerial API
            if (!("serial" in navigator)) {
                term.writeln(
                    "\x1b[31mError:\x1b[0m Web Serial API not supported!",
                );
                term.writeln(
                    "Please use a Chrome-based Browswer: e.g. Google Chrome, Chromium or Microsoft Edge",
                );
                term.writeln(
                    "\n\rAlternatively, you can try the WebSerial for Firefox Add-on:",
                );
                term.writeln(
                    "\033]8;;https://addons.mozilla.org/en-US/firefox/addon/webserial-for-firefox\033\\https://addons.mozilla.org/en-US/firefox/addon/webserial-for-firefox\033]8;;\033\\",
                );
                connectBtn.disabled = true;
            }
        </script>

        <!-- handle Emscripten startup, errors and stdio -->
        <script type="text/javascript">
            var Module = {
                print(...args) {
                    console.log(...args);
                    var text = args.join(" ");
                    term.writeln(text);
                },
                setStatus(text) {
                    console.log("Set Status: " + text);
                },
                totalDependencies: 0,
                monitorRunDependencies(left) {
                    console.log("monitorRunDependencies: " + left);
                    this.totalDependencies = Math.max(
                        this.totalDependencies,
                        left,
                    );
                    Module.setStatus(
                        left
                            ? "Preparing... (" +
                                  (this.totalDependencies - left) +
                                  "/" +
                                  this.totalDependencies +
                                  ")"
                            : "All downloads complete.",
                    );
                },
            };
            Module.setStatus("Downloading...");
            window.onerror = () => {
                Module.setStatus("Exception thrown, see JavaScript console");
                Module.setStatus = (text) => {
                    if (text) console.error("[post-exception status] " + text);
                };
            };
        </script>

        {{{ SCRIPT }}}
    </body>
</html>
